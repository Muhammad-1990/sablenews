<!DOCTYPE html>
<html lang="en" x-data="blogApp()" x-init="init()">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="theme-color" content="#1d90f5" />
    <meta name="Description" content="Sable News">
    <meta name="author" content="github.com/Muhammad-1990/sablenews">
    <title>Sable News</title>
    <meta name="description" content="Sable News">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Sable News">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-TileColor" content="#1d90f5">

    <meta property="og:title" content="Sable News" />
    <meta property="og:description " content="Sable News" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://muhammad-1990.github.io/sablenews/" />
    <meta property="og:image" content="https://muhammad-1990.github.io/sablenews/manifest-icon-512.png" />

    <meta name="github" content="github.com/muhammad-1990/sablenews" />
    <meta name="twitter" content="@sablenews" />
    <meta name="email" content="muhammad.ahmod@sableinternational.com" />


    <link rel="icon" href="https://muhammad-1990.github.io/sablenews/favicon.ico" type="image/x-icon" />
    <link rel="manifest" href="https://muhammad-1990.github.io/sablenews/manifest.json" />
    <link rel="apple-touch-icon" href="https://muhammad-1990.github.io/sablenews/manifest-icon-512.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <style>
        /* Snap scrolling */
        .snap-y {
            scroll-snap-type: y mandatory;
        }

        .snap-start {
            scroll-snap-align: start;
        }
    </style>
</head>

<body class="bg-black text-white" :class="showArticle ? 'overflow-hidden' : ''" x-data="blogApp()" x-init="init()">
    <!-- Category Tabs -->
    <!-- <nav class="fixed top-0 left-0 right-0 z-50 bg-black text-white border-b border-gray-800 overflow-x-auto">
    <div class="flex space-x-4 px-4 py-2">
      <template x-for="cat in categories" :key="cat">
        <button 
          @click="activeCategory = cat; fetchPosts(cat)" 
          class="px-4 py-2 rounded-full whitespace-nowrap"
          :class="activeCategory === cat ? 'bg-white text-black font-semibold' : 'bg-gray-800 text-gray-300'"
          x-text="cat">
        </button>
      </template>
    </div>
  </nav> -->

    <!-- Snap Feed -->
    <main class="h-screen overflow-y-scroll snap-y snap-mandatory pt-14">
        <template x-for="post in posts" :key="post.Id">
            <section class="h-screen w-full relative snap-start cursor-pointer">
                <img :src="post.meta?.image" alt="" class="absolute inset-0 w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/100 to-transparent"></div>
                <div class="absolute bottom-0 p-6" @click="openPost(post.Id)">
                    <h2 class="text-2xl font-bold" x-text="post.Title"></h2>
                    <p class="mt-2 text-sm text-gray-200" x-text="post.Summary"></p>
                </div>
            </section>
        </template>
    </main>

    <!-- Article Overlay -->
    <div class="fixed inset-x-0 bottom-0 bg-white text-black z-50 overflow-hidden transition-all duration-300 ease-in-out"
        x-show="showArticle" x-ref="overlay" :class="closing ? 'h-0 opacity-0' : (overlayExpanded ? 'h-screen opacity-100' : 'h-[50vh] opacity-100')" 
        @touchstart="startY = $event.touches[0].clientY"
        @touchend="endY = $event.changedTouches[0].clientY; handleSwipe()">
        <div class="overflow-y-auto p-6 h-full">
            <template x-if="activePost">
                <div>
                    <h2 class="text-2xl font-bold" x-text="activePost.Title"></h2>
                    <p class="mt-2 mb-4 text-gray-600" x-text="activePost.Summary"></p>
                    <div class="prose prose-lg max-w-none" x-html="activePost.Content"></div>
                </div>
            </template>
            <template x-if="loading">
                <p class="text-gray-500">Loading...</p>
            </template>
        </div>
    </div>

</body>

<script>
    function parseMetaTags(metaString) {
        const meta = {};
        metaString
            ?.split(/<br\s*\/?>|\r?\n/)
            .map(line => line.trim())
            .filter(line => line.length > 0)
            .forEach(line => {
                const [key, ...rest] = line.split("=");
                if (key && rest.length) {
                    meta[key.trim()] = rest.join("=").trim();
                }
            });
        return meta;
    }

    function blogApp() {
        return {
            categories: ["All", "Finance", "Travel", "Lifestyle"],
            activeCategory: "All",
            posts: [],
            activePost: null,
            showArticle: false,
            overlayExpanded: false,
            closing: false,
            loading: false,
            startY: 0,
            endY: 0,
            async init() {
                await this.fetchPosts(this.activeCategory);
            },

            async fetchPosts(category) {
                const res = await fetch("https://www.sableinternational.com/api/blogapp/blogposts?$orderby=LastModified desc&$filter=ParentId eq b92c94f8-ab99-4522-b9e1-0f194960f07c&$top=5");
                const data = await res.json();
                this.posts = (data.value || data).map(post => ({
                    ...post,
                    meta: parseMetaTags(post.BlogPostMetaTags)
                }));
            },

            async openPost(id) {
                this.loading = true;
                this.closing = true;
                this.showArticle = true;
                this.overlayExpanded = false;
                setTimeout(() => { this.closing = false; }, 10);
                try {
                    const res = await fetch(`https://www.sableinternational.com/api/blogapp/blogposts(${id})?$select=Id,Title,Summary,Content`);
                    const data = await res.json();
                    this.activePost = data;
                } catch (err) {
                    console.error("Failed to load post", err);
                } finally {
                    this.loading = false;
                }
            },

            handleSwipe() {
                const delta = this.startY - this.endY;
                if (delta > 50) {
                    // swipe up expands overlay
                    this.overlayExpanded = true;
                } else if (delta < -50) {
                    // swipe down
                    if (this.overlayExpanded) {
                        // collapse back to half
                        this.overlayExpanded = false;
                    } else {
                        // dismiss overlay entirely
                        this.closing = true;
                        setTimeout(() => { 
                            this.showArticle = false; 
                            this.closing = false; 
                        }, 300);
                    }
                }
            }
        }
    }

    window.onload = async () => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker
                .register('./service-worker.js');
        }
    }
</script>

</html>